# https://circleci.com/docs/configuration#machine
machine:
  php:
    # https://circleci.com/docs/environment#php
    version: 5.5.11
  node:
    version: 4.2.6
  environment:
    DOCROOT: "$HOME/$CIRCLE_PROJECT_REPONAME/web"
    # DB config. Using default CircleCI's database.
    DB_NAME: "circle_test"
    DB_USERNAME: "ubuntu"
    DB_PASSWORD: ""
    SERVER: server.local
    WEB_USER: $(whoami)
    WEB_GROUP: www-data
    TERMINUS_ENV: "ci-909"
    TERMINUS_SITE: "nerdologues-composer"
    SITE_ENV: $TERMINUS_SITE.$TERMINUS_ENV
    MIGRATION_SOURCE_URL: "http://migr-prep2-nerdologues.pantheonsite.io"
    PANTHEON_SITE_URL: "http://$TERMINUS_ENV-$TERMINUS_SITE.pantheonsite.io"
    PATH: $PATH:~/.composer/vendor/bin:~/terminus/bin
    NOTIFY: 'scripts/github/add-commit-comment {project} {sha} "Created multidev environment [{site}#{env}]({dashboard-url})." {site-url}'
    BUILD_TOOLS_VERSION: '^1'
  hosts:
    server.local: 127.0.0.1

dependencies:
  cache_directories:
    - ~/.composer/cache
  override:
    - ./scripts/circle-ci/install-globals.sh
    - composer install  --optimize-autoloader
  post:
    ##############################- ./scripts/circle-ci/prepare-drupal-server.sh
    - terminus -n build:env:create "$TERMINUS_SITE.dev" "$TERMINUS_ENV" --yes

test:
  override:
    - echo 'hi'
    ##############################- composer circle-tests
  post:
    ##############################- ./scripts/circle-ci/deploy-to-multidev.sh
    - cd backstop && ./run-backstop.sh
